{% extends "base.html" %}
{% block title %}Dashboard | AcadeGrade{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Hero / Welcome -->
  <div class="p-4 mb-4 rounded-4 text-white shadow-sm" 
       style="background: linear-gradient(90deg, #0d6efd, #6610f2);" >
    <h2 class="fw-bold">üëã Welcome back, <span id="userName">Student</span></h2>
    <p class="mb-0">Track, calculate, and manage your CGPA across semesters and years effortlessly.</p>
  </div>

  <!-- Quick Stats -->
  <div class="row text-center mb-4" id="quickStats">
    <div class="col-md-4 mb-3" data-aos="fade-up">
      <div class="card shadow-sm h-100 border-0 rounded-3">
        <div class="card-body">
          <h6 class="text-muted">Total Sheets</h6>
          <h3 class="fw-bold" id="statTotalSheets">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3" data-aos="fade-up" data-aos-delay="100">
      <div class="card shadow-sm h-100 border-0 rounded-3">
        <div class="card-body">
          <h6 class="text-muted">Average CGPA</h6>
          <h3 class="fw-bold text-success" id="statAvgCgpa">-</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3" data-aos="fade-up" data-aos-delay="200">
      <div class="card shadow-sm h-100 border-0 rounded-3">
        <div class="card-body">
          <h6 class="text-muted">Best CGPA</h6>
          <h3 class="fw-bold text-primary" id="statBestCgpa">-</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Your Result Sheets</h3>
    <div class="btn-group" role="group">
      <!-- Print -->
      <button class="btn btn-outline-secondary" id="printBtn">
        <i class="bi bi-printer me-1"></i> Print
      </button>

      <!-- Client-side PDF -->
      <button class="btn btn-outline-danger" id="pdfBtn">
        <i class="bi bi-file-earmark-pdf me-1"></i> Client PDF
      </button>

      <!-- Server-side PDF (ReportLab) -->
      <a href="#" id="serverPdfBtn" class="btn btn-danger">
          <i class="bi bi-download me-1"></i> Export (Server PDF)
      </a>


      <!-- Create New -->
      <button class="btn btn-primary" id="createSheetBtn">
        + New Result Sheet
      </button>
    </div>
  </div>




  <!-- Result Sheets -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">üìë Your Result Sheets</h4>
  </div>
  <div id="sheetsList" class="row g-3">
    <!-- JS will render cards here -->
  </div>

  <!-- Top Create Button -->
  <button class="btn btn-primary" id="createSheetBtn">
    + New Result Sheet
  </button>

  ...

  <!-- Floating Action Button -->
  <button class="btn btn-primary rounded-circle shadow-lg position-fixed"
          style="bottom: 30px; right: 30px; width: 60px; height: 60px; font-size: 1.5rem;"
          id="fabCreateSheetBtn">
    +
  </button>



</div>

<!-- Create Sheet Modal -->
<div class="modal fade" id="createSheetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow-lg">
      <form id="createSheetForm" class="p-3">
        <h5 class="fw-bold mb-3">üéì Create New Result Sheet</h5>
        <div class="mb-2"><label class="form-label">Student Name</label><input name="student_name" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">University</label><input name="university" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Faculty</label><input name="faculty" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Department</label><input name="department" class="form-control"></div>
        <div class="row g-2">
          <div class="col"><label class="form-label">Years of Study</label><input name="years_of_study" type="number" value="4" class="form-control" required></div>
          <div class="col"><label class="form-label">Semesters/Year</label><input name="semesters_per_year" type="number" value="2" class="form-control" required></div>
        </div>
        <div class="mb-2 mt-2"><label class="form-label">Entry Year</label><input name="entry_year" class="form-control" placeholder="2021/2022"></div>
        <div class="mb-2">
          <label class="form-label">Mode</label>
          <select name="mode" class="form-select">
            <option value="zeros">All zeros (Build up)</option>
            <option value="available">Based on availability</option>
          </select>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Sheet Modal -->
<div class="modal fade" id="editSheetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow-lg">
      <form id="editSheetForm" class="p-3">
        <h5 class="fw-bold mb-3">‚úèÔ∏è Edit Result Sheet</h5>
        <input type="hidden" name="sheet_id" id="editSheetId">
        <div class="mb-2"><label class="form-label">Student Name</label><input name="student_name" id="editStudentName" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">University</label><input name="university" id="editUniversity" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Faculty</label><input name="faculty" id="editFaculty" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Department</label><input name="department" id="editDepartment" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Entry Year</label><input name="entry_year" id="editEntryYear" class="form-control"></div>
        <div class="mb-2">
          <label class="form-label">Mode</label>
          <select name="mode" id="editMode" class="form-select">
            <option value="zeros">All zeros (Build up)</option>
            <option value="available">Based on availability</option>
          </select>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Semester Modal -->
<div class="modal fade" id="semesterModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3 rounded-4">
      <h5 id="semesterModalTitle" class="fw-bold mb-3">Semester</h5>
      <div id="semesterCourses"></div>
      <hr>
      <form id="addCourseForm" class="row g-2">
        <input type="hidden" name="semester_id" id="courseSemesterId">
        <div class="col-3"><input name="code" class="form-control" placeholder="Code"></div>
        <div class="col-4"><input name="title" class="form-control" placeholder="Course Title"></div>
        <div class="col-1"><input name="credit_unit" type="number" class="form-control" value="3"></div>
        <div class="col-2"><input name="incourse" type="number" class="form-control" value="0" placeholder="Incourse"></div>
        <div class="col-2"><input name="exam" type="number" class="form-control" value="0" placeholder="Exam"></div>
        <div class="col-12 text-end mt-2"><button class="btn btn-primary">+ Add Course</button></div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow-lg">
      <form id="editCourseForm" class="p-3">
        <h5 class="fw-bold mb-3">‚úèÔ∏è Edit Course</h5>
        <input type="hidden" name="course_id" id="editCourseId">
        <div class="mb-2"><label class="form-label">Code</label><input name="code" id="editCode" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Title</label><input name="title" id="editTitle" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Credit Unit</label><input type="number" name="credit_unit" id="editCredit" class="form-control" required></div>
        <div class="row g-2">
          <div class="col"><label class="form-label">Incourse</label><input type="number" name="incourse" id="editIncourse" class="form-control"></div>
          <div class="col"><label class="form-label">Exam</label><input type="number" name="exam" id="editExam" class="form-control"></div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">
        Hello, world! This is a toast message.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const createBtn = document.getElementById('createSheetBtn');
  const fabBtn = document.getElementById('fabCreateSheetBtn');
  const createModal = new bootstrap.Modal(document.getElementById('createSheetModal'));
  const createForm = document.getElementById('createSheetForm');

  // ----------------- CREATE SHEET -----------------
  [createBtn, fabBtn].forEach(btn => {
    if (btn) btn.addEventListener('click', () => createModal.show());
  });

  createForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!window.currentUserUid) return showToast('You must be signed in first.', 'warning');

    const formData = new FormData(createForm);
    const payload = Object.fromEntries(formData.entries());
    payload.uid = window.currentUserUid;

    const res = await fetch('/api/create-sheet/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.status === 'ok') {
      createModal.hide();
      showToast('Sheet created successfully!', 'success');
      loadSheets();
    } else {
      showToast('Error: ' + (data.error || 'unknown'), 'danger');
    }
  });

  // ----------------- LOAD SHEETS -----------------
  async function loadSheets() {
    if (!window.currentUserUid) {
      document.getElementById("sheetsList").innerHTML = "<p class='text-muted'>Sign in to see your sheets.</p>";
      return;
    }

    const res = await fetch(`/api/list-sheets/?uid=${window.currentUserUid}`);
    const data = await res.json();

    const container = document.getElementById("sheetsList");
    container.innerHTML = "";

    if (!data.sheets || data.sheets.length === 0) {
      container.innerHTML = "<p class='text-muted'>No result sheets yet. Click <b>+ New Result Sheet</b> to start.</p>";
      return;
    }

    data.sheets.forEach(sheet => {
      const card = document.createElement("div");
      card.className = "col-md-6";
      const cgpaPercent = Math.min((sheet.cgpa / 5) * 100, 100);

      card.innerHTML = `
        <div class="card shadow-sm h-100 border-0 rounded-4" data-aos="fade-up">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="fw-bold mb-0"><i class="bi bi-journal-bookmark-fill text-primary me-2"></i> ${sheet.student_name}</h5>
              <span class="badge bg-info text-dark">${sheet.mode === "zeros" ? "Build-up" : "Availability"}</span>
            </div>
            <p class="text-muted small mb-2">${sheet.university || ""}</p>

            <div class="mb-2">
              <span class="badge bg-secondary">üìÜ ${sheet.years_of_study} yrs</span>
              <span class="badge bg-secondary">üìö ${sheet.semesters_per_year} sem/yr</span>
              <span class="badge bg-secondary">üéì Entry: ${sheet.entry_year}</span>
            </div>

            <p class="mb-1"><b>CGPA:</b> ${sheet.cgpa.toFixed(2)}</p>
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar ${sheet.cgpa >= 4 ? "bg-success" : sheet.cgpa >= 3 ? "bg-warning" : "bg-danger"}"
                   role="progressbar" style="width: ${cgpaPercent}%"></div>
            </div>

            <div class="d-flex justify-content-between">
              <button class="btn btn-sm btn-outline-primary viewSheetBtn" data-id="${sheet.id}">
                <i class="bi bi-eye"></i> Open
              </button>
              <button class="btn btn-sm btn-outline-secondary editSheetBtn" data-id="${sheet.id}">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger deleteSheetBtn" data-id="${sheet.id}">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
      container.appendChild(card);
    });

    // DELETE
    document.querySelectorAll(".deleteSheetBtn").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (!confirm("Are you sure you want to delete this sheet?")) return;
        const id = btn.dataset.id;
        const res = await fetch(`/api/delete-sheet/${id}/?uid=${window.currentUserUid}`, { method: "DELETE" });
        const data = await res.json();
        if (data.status === "ok") {
          showToast("Sheet deleted successfully!", "success");
          loadSheets();
        } else {
          showToast("Error deleting: " + data.error, "danger");
        }
      });
    });

    // VIEW
    document.querySelectorAll(".viewSheetBtn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        const res = await fetch(`/api/sheet/${id}/`);
        const data = await res.json();
        renderSheetDetail(data);
      });
    });
  }

  // ----------------- RENDER SHEET DETAIL -----------------
  function attachServerPdfHandler(sheetId) {
    const btn = document.getElementById("serverPdfBtn");
    btn.href = `/api/sheet/${sheetId}/pdf/`;
  }

  function renderSheetDetail(sheet) {
    const container = document.getElementById("sheetsList");
    container.innerHTML = `
      <div class="card shadow-sm border-0 rounded-4 mb-4 p-3" data-aos="zoom-in">
        <h4 class="fw-bold mb-1"><i class="bi bi-person-badge me-2 text-primary"></i> ${sheet.student_name}</h4>
        <p class="text-muted small mb-2"><i class="bi bi-building me-2"></i>${sheet.university}</p>
        <p><b>Total CGPA:</b> ${sheet.cgpa.toFixed(2)}</p>
      </div>
    `;

    sheet.years.forEach((y, index) => {
      const yearCard = document.createElement("div");
      yearCard.className = "accordion mb-3";
      yearCard.innerHTML = `
        <div class="accordion-item rounded-3 shadow-sm border-0">
          <h2 class="accordion-header" id="heading${index}">
            <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
              <i class="bi bi-calendar-check me-2 text-primary"></i> ${y.year_label}
              <span class="badge ms-2 ${y.year_gpa >= 4 ? "bg-success" : y.year_gpa >= 3 ? "bg-warning" : "bg-danger"}">
                GPA: ${y.year_gpa.toFixed(2)}
              </span>
            </button>
          </h2>
          <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? "show" : ""}">
            <div class="accordion-body row g-3">
              ${y.semesters.map(s => `
                <div class="col-md-6">
                  <div class="card h-100 border-0 shadow-sm rounded-3 p-3" data-aos="fade-up">
                    <h6 class="fw-bold text-primary"><i class="bi bi-book-half me-2"></i>${s.label}</h6>
                    <p class="mb-1"><b>GPA:</b> ${s.gpa.toFixed(2)}</p>
                    <div class="progress mb-2" style="height: 6px;">
                      <div class="progress-bar ${s.gpa >= 4 ? "bg-success" : s.gpa >= 3 ? "bg-warning" : "bg-danger"}"
                           role="progressbar" style="width: ${(s.gpa/5)*100}%"></div>
                    </div>
                    <ul class="list-group list-group-flush small mb-2">
                      ${s.courses.map(c => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <div>
                            <span class="fw-bold">${c.code}</span> (${c.credit_unit}u) - ${c.title}
                          </div>
                          <div>
                            <span class="badge bg-${c.grade === "A" ? "success" : c.grade === "B" ? "primary" : c.grade === "C" ? "info" : c.grade === "D" ? "warning" : c.grade === "E" ? "secondary" : "danger"}">
                              ${c.grade} [${c.score}]
                            </span>
                            <button class="btn btn-sm btn-outline-secondary ms-2 editCourseBtn" data-id="${c.id}">
                              <i class="bi bi-pencil"></i>
                            </button>
                          </div>
                        </li>
                      `).join("")}
                    </ul>
                    <button class="btn btn-sm btn-outline-success addCourseBtn" data-id="${s.id}" data-label="${s.label}">
                      <i class="bi bi-plus-circle me-1"></i> Add Course
                    </button>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        </div>
      `;
      attachServerPdfHandler(sheet.id);
      container.appendChild(yearCard);
    });

    // ADD COURSE
    document.querySelectorAll(".addCourseBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.getElementById("courseSemesterId").value = btn.dataset.id;
        document.getElementById("semesterModalTitle").innerText = btn.dataset.label;
        new bootstrap.Modal(document.getElementById("semesterModal")).show();
      });
    });

    attachEditCourseHandlers();
  }

  // ----------------- EDIT COURSE -----------------
  function attachEditCourseHandlers() {
    document.querySelectorAll(".editCourseBtn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        const res = await fetch(`/api/course/${id}/`);
        const data = await res.json();

        if (data.error) return showToast("Error: " + data.error, "danger");

        document.getElementById("editCourseId").value = id;
        document.getElementById("editCode").value = data.code;
        document.getElementById("editTitle").value = data.title;
        document.getElementById("editCredit").value = data.credit_unit;
        document.getElementById("editIncourse").value = data.incourse;
        document.getElementById("editExam").value = data.exam;

        new bootstrap.Modal(document.getElementById("editCourseModal")).show();
      });
    });
  }

  document.getElementById("editCourseForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = Object.fromEntries(new FormData(e.target).entries());
    const id = payload.course_id;
    delete payload.course_id;

    const res = await fetch(`/api/update-course/${id}/`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.status === "ok") {
      bootstrap.Modal.getInstance(document.getElementById("editCourseModal")).hide();
      showToast("Course updated successfully!", "success");
      loadSheets();
    } else {
      showToast("Error updating course: " + data.error, "danger");
    }
  });

  // ----------------- EDIT SHEET -----------------
  document.addEventListener("click", async (e) => {
    if (e.target.closest(".editSheetBtn")) {
      const id = e.target.closest(".editSheetBtn").dataset.id;

      const res = await fetch(`/api/sheet/${id}/`);
      const sheet = await res.json();

      document.getElementById("editSheetId").value = sheet.id;
      document.getElementById("editStudentName").value = sheet.student_name;
      document.getElementById("editUniversity").value = sheet.university || "";
      document.getElementById("editFaculty").value = sheet.faculty || "";
      document.getElementById("editDepartment").value = sheet.department || "";
      document.getElementById("editEntryYear").value = sheet.entry_year || "";
      document.getElementById("editMode").value = sheet.mode;

      new bootstrap.Modal(document.getElementById("editSheetModal")).show();
    }
  });

  document.getElementById("editSheetForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = Object.fromEntries(new FormData(e.target).entries());
    const id = payload.sheet_id;
    delete payload.sheet_id;

    const res = await fetch(`/api/update-sheet/${id}/`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.status === "ok") {
      bootstrap.Modal.getInstance(document.getElementById("editSheetModal")).hide();
      showToast("Sheet updated successfully!", "success");
      loadSheets();
    } else {
      showToast("Error updating sheet: " + data.error, "danger");
    }
  });

  // ----------------- ADD COURSE -----------------
  document.getElementById('addCourseForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = Object.fromEntries(new FormData(e.target).entries());
    const res = await fetch('/api/add-course/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.status === 'ok') {
      showToast("Course added successfully!", "success");
      loadSheets();
    } else {
      showToast("Error adding course: " + data.error, "danger");
    }
  });

  // ----------------- EXPORT & PRINT -----------------
  document.getElementById("printBtn").addEventListener("click", () => window.print());

  document.getElementById("pdfBtn").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "a4");
    const element = document.getElementById("sheetsList");
    await doc.html(element, {
      callback: pdf => pdf.save("result_sheet.pdf"),
      margin: [20, 20, 20, 20],
      autoPaging: "text",
      x: 10, y: 10, width: 500, windowWidth: 1000
    });
  });

  // ----------------- INIT -----------------
  loadSheets();
});

// ----------------- TOAST HELPER -----------------
function showToast(message, type = "primary") {
  const toastEl = document.getElementById("liveToast");
  const toastBody = document.getElementById("toastMessage");
  toastBody.textContent = message;
  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  new bootstrap.Toast(toastEl).show();
}
</script>

{% endblock %}
