{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard | AcadeGrade{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Hero / Welcome -->
  <div class="card border-0 rounded-4 shadow-lg mb-4" style="background: var(--primary-gradient);">
    <div class="card-body p-4 text-white">
      <div class="d-flex align-items-center justify-content-between">
        <div class="flex-grow-1">
          <h2 class="fw-bold mb-2">
            <i class="bi bi-person-circle me-2"></i>
            Welcome back, <span id="userName">Student</span>
          </h2>
          <p class="mb-0 opacity-90">Track, calculate, and manage your CGPA across semesters and years effortlessly.</p>
        </div>
        <div class="d-none d-lg-block">
          <i class="bi bi-mortarboard-fill" style="font-size: 3rem; opacity: 0.3;"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row mb-4" id="quickStats">
    <div class="col-12 col-md-4 mb-3" data-aos="fade-up">
      <div class="stat-card">
        <div class="stat-icon" style="background: var(--info);">
          <i class="bi bi-journal-text"></i>
        </div>
        <div class="stat-value text-primary" id="statTotalSheets">
          <div class="loading-skeleton" style="width: 40px; height: 32px; margin: 0 auto;"></div>
        </div>
        <div class="stat-label">Total Sheets</div>
      </div>
    </div>
    <div class="col-12 col-md-4 mb-3" data-aos="fade-up" data-aos-delay="100">
      <div class="stat-card text-center">
        <div class="cgpa-circle mx-auto" id="avgCgpaCircle">
          <svg viewBox="0 0 100 100">
            <circle class="circle-bg" cx="50" cy="50" r="42"></circle>
            <circle class="circle-progress" cx="50" cy="50" r="42" 
                    stroke-dasharray="0 264" id="avgCgpaProgress"></circle>
          </svg>
          <div class="circle-text">
            <div class="stat-value text-success" id="statAvgCgpa">
              <div class="loading-skeleton" style="width: 30px; height: 24px; margin: 0 auto;"></div>
            </div>
          </div>
        </div>
        <div class="stat-label mt-2">Average CGPA</div>
        <div class="cgpa-indicator mt-2" id="avgCgpaIndicator" style="display: none;">
          <i class="bi bi-circle-fill"></i>
          <span id="avgCgpaStatus">-</span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4 mb-3" data-aos="fade-up" data-aos-delay="200">
      <div class="stat-card text-center">
        <div class="cgpa-circle mx-auto" id="bestCgpaCircle">
          <svg viewBox="0 0 100 100">
            <circle class="circle-bg" cx="50" cy="50" r="42"></circle>
            <circle class="circle-progress" cx="50" cy="50" r="42" 
                    stroke-dasharray="0 264" id="bestCgpaProgress"></circle>
          </svg>
          <div class="circle-text">
            <div class="stat-value" style="color: var(--secondary-color);" id="statBestCgpa">
              <div class="loading-skeleton" style="width: 30px; height: 24px; margin: 0 auto;"></div>
            </div>
          </div>
        </div>
        <div class="stat-label mt-2">Best CGPA</div>
        <div class="cgpa-indicator mt-2" id="bestCgpaIndicator" style="display: none;">
          <i class="bi bi-trophy-fill"></i>
          <span id="bestCgpaStatus">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 gap-3">
    <h3 class="fw-bold mb-0">
      <i class="bi bi-collection-fill me-2 text-primary"></i>
      Your Result Sheets
    </h3>
    <div class="btn-group w-100 w-lg-auto" role="group">
      <button class="btn btn-outline-secondary" id="printExportBtn">
        <i class="bi bi-printer me-1"></i> 
        <span class="d-none d-sm-inline">Print/Export</span>
      </button>
      <button class="btn btn-primary" id="createSheetBtn">
        <span class="btn-loading d-none">
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Creating...
        </span>
        <span class="btn-text">
          <i class="bi bi-plus-circle me-1"></i> 
          <span class="d-none d-sm-inline">New Result Sheet</span>
          <span class="d-sm-none">New Sheet</span>
        </span>
      </button>
    </div>
  </div>

  <!-- Result Sheets -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">ðŸ“‘ Your Result Sheets</h4>
  </div>
  <div id="sheetsList" class="row g-3">
    <!-- Loading skeleton -->
    <div class="col-12">
      <div class="card border-0 rounded-4 shadow-sm p-4">
        <div class="d-flex align-items-center">
          <div class="loading-skeleton rounded-circle me-3" style="width: 48px; height: 48px;"></div>
          <div class="flex-grow-1">
            <div class="loading-skeleton mb-2" style="width: 60%; height: 20px;"></div>
            <div class="loading-skeleton" style="width: 40%; height: 16px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="btn btn-primary rounded-circle shadow-lg position-fixed d-md-none"
          style="bottom: 30px; right: 30px; width: 60px; height: 60px; font-size: 1.5rem; z-index: 1000;"
          id="fabCreateSheetBtn"
          title="Create New Result Sheet"
          aria-label="Create New Result Sheet">
    <i class="bi bi-plus"></i>
  </button>

</div>

<!-- Create Sheet Modal -->
<div class="modal fade" id="createSheetModal" tabindex="-1" aria-labelledby="createSheetModalLabel">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="createSheetModalLabel">
          <i class="bi bi-mortarboard me-2 text-primary"></i>
          Create New Result Sheet
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createSheetForm" class="modal-body pt-2">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label fw-semibold">Student Name</label>
            <input name="student_name" class="form-control" required autocomplete="name">
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">University</label>
            <input name="university" class="form-control" autocomplete="organization">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Faculty</label>
            <input name="faculty" class="form-control">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Department</label>
            <input name="department" class="form-control">
          </div>
          <div class="col-6 col-md-6">
            <label class="form-label fw-semibold">Years of Study</label>
            <input name="years_of_study" type="number" value="4" class="form-control" required min="1" max="10">
          </div>
          <div class="col-6 col-md-6">
            <label class="form-label fw-semibold">Semesters/Year</label>
            <input name="semesters_per_year" type="number" value="2" class="form-control" required min="1" max="4">
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Entry Year</label>
            <input name="entry_year" class="form-control" placeholder="2021/2022">
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Mode</label>
            <select name="mode" class="form-select">
              <option value="zeros">All zeros (Build up)</option>
              <option value="available">Based on availability</option>
            </select>
          </div>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-outline-secondary order-2 order-sm-1" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary order-1 order-sm-2" id="createSheetSubmitBtn">
            <span class="btn-loading d-none">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Creating...
            </span>
            <span class="btn-text">
              <i class="bi bi-check-circle me-1"></i> Create Sheet
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Sheet Modal -->
<div class="modal fade" id="editSheetModal" tabindex="-1" aria-labelledby="editSheetModalLabel">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="editSheetModalLabel">
          <i class="bi bi-pencil-square me-2 text-primary"></i>
          Edit Result Sheet
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editSheetForm" class="modal-body pt-2">
        <input type="hidden" name="sheet_id" id="editSheetId">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label fw-semibold">Student Name</label>
            <input name="student_name" id="editStudentName" class="form-control" required>
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">University</label>
            <input name="university" id="editUniversity" class="form-control">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Faculty</label>
            <input name="faculty" id="editFaculty" class="form-control">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Department</label>
            <input name="department" id="editDepartment" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Entry Year</label>
            <input name="entry_year" id="editEntryYear" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Mode</label>
            <select name="mode" id="editMode" class="form-select">
              <option value="zeros">All zeros (Build up)</option>
              <option value="available">Based on availability</option>
            </select>
          </div>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-outline-secondary order-2 order-sm-1" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary order-1 order-sm-2" id="editSheetSubmitBtn">
            <span class="btn-loading d-none">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Updating...
            </span>
            <span class="btn-text">
              <i class="bi bi-check-circle me-1"></i> Update Sheet
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Semester Modal (Single Entry) -->
<div class="modal fade" id="semesterModal" tabindex="-1" aria-labelledby="semesterModalLabel">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <h5 id="semesterModalTitle" class="modal-title fw-bold" id="semesterModalLabel">
          <i class="bi bi-book me-2 text-primary"></i>
          Semester Courses
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="semesterCourses" class="mb-4"></div>
        <hr class="my-4">
        <h6 class="fw-bold mb-3">
          <i class="bi bi-plus-circle me-2 text-success"></i>
          Add New Course
        </h6>
        <form id="addCourseForm">
          <input type="hidden" name="semester_id" id="courseSemesterId">
          <div class="row g-3">
            <div class="col-12 col-md-3">
              <label class="form-label fw-semibold">Code</label>
              <input name="code" class="form-control" placeholder="CSC101" required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Course Title</label>
              <input name="title" class="form-control" placeholder="Introduction to Computing" required>
            </div>
            <div class="col-4 col-md-2">
              <label class="form-label fw-semibold">Credit</label>
              <input name="credit_unit" type="number" class="form-control" value="3" min="1" max="6" required>
            </div>
            <div class="col-4 col-md-1.5">
              <label class="form-label fw-semibold">CA</label>
              <input name="incourse" type="number" class="form-control" value="0" min="0" max="40" placeholder="30">
            </div>
            <div class="col-4 col-md-1.5">
              <label class="form-label fw-semibold">Exam</label>
              <input name="exam" type="number" class="form-control" value="0" min="0" max="70" placeholder="60">
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-success w-100 w-md-auto" id="addCourseSubmitBtn">
                <span class="btn-loading d-none">
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Adding...
                </span>
                <span class="btn-text">
                  <i class="bi bi-plus-circle me-1"></i> Add Course
                </span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Batch Course Entry Modal -->
<div class="modal fade" id="batchCourseModal" tabindex="-1" aria-labelledby="batchCourseModalLabel">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-fullscreen-md-down">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="batchCourseModalLabel">
          <i class="bi bi-table me-2 text-primary"></i>
          Batch Add Courses
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="batchCourseForm" class="modal-body pt-2">
        <input type="hidden" name="semester_id" id="batchCourseSemesterId">
        <div class="table-responsive mb-3">
          <table class="table table-bordered align-middle" id="batchCourseTable">
            <thead class="table-light">
              <tr>
                <th>Code</th>
                <th>Title</th>
                <th>Credit Unit</th>
                <th>CA</th>
                <th>Exam</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be generated dynamically by JS -->
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between mb-3">
          <button type="button" class="btn btn-outline-success" id="addBatchRowBtn">
            <i class="bi bi-plus-circle me-1"></i> Add Row
          </button>
          <button type="submit" class="btn btn-primary" id="saveBatchCoursesBtn">
            <span class="btn-loading d-none">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Saving...
            </span>
            <span class="btn-text">
              <i class="bi bi-check-circle me-1"></i> Save All Courses
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="editCourseModalLabel">
          <i class="bi bi-pencil-square me-2 text-primary"></i>
          Edit Course
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editCourseForm" class="modal-body pt-2">
        <input type="hidden" name="course_id" id="editCourseId">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Course Code</label>
            <input name="code" id="editCode" class="form-control" required>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Credit Unit</label>
            <input type="number" name="credit_unit" id="editCredit" class="form-control" min="1" max="6" required>
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Course Title</label>
            <input name="title" id="editTitle" class="form-control" required>
          </div>
          <div class="col-6 col-md-6">
            <label class="form-label fw-semibold">Continuous Assessment</label>
            <input type="number" name="incourse" id="editIncourse" class="form-control" min="0" max="40">
          </div>
          <div class="col-6 col-md-6">
            <label class="form-label fw-semibold">Examination</label>
            <input type="number" name="exam" id="editExam" class="form-control" min="0" max="70">
          </div>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-outline-secondary order-2 order-sm-1" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary order-1 order-sm-2" id="editCourseSubmitBtn">
            <span class="btn-loading d-none">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Updating...
            </span>
            <span class="btn-text">
              <i class="bi bi-check-circle me-1"></i> Update Course
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">
        Hello, world! This is a toast message.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script src="{% static 'js/dashboard.js' %}"></script>

<!-- Print/Export Modal -->
<div class="modal fade" id="printExportModal" tabindex="-1" aria-labelledby="printExportModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="printExportModalLabel">
          <i class="bi bi-printer me-2 text-primary"></i>
          Print / Export Result Sheet
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="printExportForm" class="modal-body pt-2">
        <div class="mb-3">
          <label class="form-label fw-semibold">Select Result Sheet</label>
          <select class="form-select" id="printSheetSelect" required>
            <option value="" disabled selected>Select a sheet...</option>
            <!-- Sheets will be populated by JS -->
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">Scope</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="printScope" id="scopeWhole" value="whole" checked>
            <label class="form-check-label" for="scopeWhole">Whole Result Sheet (All Semesters)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="printScope" id="scopeSemester" value="semester">
            <label class="form-check-label" for="scopeSemester">Single Semester</label>
          </div>
        </div>
        <div class="mb-3 d-none" id="semesterSelectGroup">
          <label class="form-label fw-semibold">Select Year & Semester</label>
          <select class="form-select" id="printSemesterSelect">
            <option value="" disabled selected>Select semester...</option>
            <!-- Semesters will be populated by JS -->
          </select>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-outline-secondary order-2 order-sm-1" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary order-1 order-sm-2" id="printExportPreviewBtn">
            <i class="bi bi-eye me-1"></i> Preview
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Print/Export Preview Modal -->
<div class="modal fade" id="printPreviewModal" tabindex="-1" aria-labelledby="printPreviewModalLabel">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="printPreviewModalLabel">
          <i class="bi bi-eye me-2 text-primary"></i>
          Print Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2" id="printPreviewContent">
  <div id="printPreviewStudentInfo" class="mb-3"></div>
  <div id="printPreviewResultTable" class="mb-3"></div>
  <div id="printPreviewAnalysis" class="mt-4"></div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="printPreviewPrintBtn">
          <i class="bi bi-printer me-1"></i> Print
        </button>
        <button type="button" class="btn btn-danger" id="printPreviewPdfBtn">
          <i class="bi bi-file-earmark-pdf me-1"></i> Export PDF
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
